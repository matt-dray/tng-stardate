---
title: "R Trek"
subtitle: "Extracting and exploring Star Trek star dates with R"
author: "Matt Dray & Adriana De Palma"
output:
  html_document:
    theme: united
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, message = FALSE)
library(emo)
```

`r emo::ji('star')`
`r emo::ji('date')`
`r emo::ji('page_with_curl')`
`r emo::ji("point_right")`
`r emo::ji("open_book")`
`r emo::ji("man_facepalming")`
`r emo::ji("vulcan_salute")`
`r emo::ji("nerd_face")`

***

# Captain’s log

>Star date 71676.3[^1]. Our mission is to use [R statistical software]() to extract star dates mentioned in the captain's log from the scripts of *Star Trek: The Next Generation* and observe their progression over the course of the show’s seven seasons. There appears to be some mismatch in the frequency of digits after the decimal point – could this indicate poor abillity to choose random numbers? Or something more sinister? We shall venture deep into uncharted territory for answers...

# Make it so!

Download all the scripts from [Star Trek: The Next Generation](https://en.wikipedia.org/wiki/Star_Trek:_The_Next_Generation) from the [Star Trek Minutiae](http://www.st-minutiae.com/resources/scripts/#thenextgeneration) website. This is provided as a zipped folder containing 276 text files numbered consecutively from 102 to 277.

# Energise!

Ready the workspace by loading the packages we'll need for data manipulation.

```{r packages}
library(readr)  # read files
library(purrr)  # iterate functions over files
library(stringr)  # manipulate strings
library(dplyr)  # data manipulation and pipe opeartor (%>%)
```

# Lieutenant Commander Data

We're going to extract the content of the the text files using the `read_lines()` function from the `readr` package. We'll iterate over each file with the `map()` function from the `purrr` package to read them into a list object where each element is a script.

```{r read}
scripts <- purrr::map(
  list.files(  # create vector of filepath strings to each file
    "data/scripts",  # file location of the text files 
    full.names = TRUE  # e.g. "data/scripts/102.txt"
    ),
  readr::read_lines # read the content from each filepath
  )
```

We can take a look at some example lines (`[17:34]`) from the title page of the first script (element `[[1]]`).

```{r }
scripts[[1]][17:34]
```

Our first example of a star date is in the Captain's log voiceover in lines 46 to 50 of the first script.

```{r }
scripts[[1]][46:50]
```

# Engage! 

We want to extract stardate strings from each script. These are in the form XXXXX.X, where 'X' is a digit. We want to capture the stardates mentioned as part of the captain's log voiceover where possible, so we can start our search pattern with 'date'. This will help us avoid matching to strings that have a stardate-like pattern but aren't stardates

We can extract these with `str_extract_all()` from the `stringr` package, using a [regex](https://github.com/zeeshanu/learn-regex/blob/master/README.md) (regular expression). Our regex is written `date[:space:][[:digit:]\\.[:digit:]]{7}`. This means 'find a string that starts with the word date followed by a space (`date `), which is followed by a string that contains digits (`[:digit:]`) with a period (`\\.`) inside, with a total length of seven characters (`{7}`)'.

This will provide a list object where each element contains the regex-matched string for a script.

```{r extract-stardate}
stardate_extract <- stringr::str_extract_all(
  scripts,  # location from which to extract
  pattern = "date[:space:][[:digit:]\\.[:digit:]]{7}"  # regex
)

head(stardate_extract)  # see the first few list elements
```

We're now going to tody the data to:

* turn the list into a dataframe (`tibble::enframe()`) with one row per episode
* turn this into a dataframe with one row per stardate (`tidyr::unnest()`)
* rename the columns 'episode' and 'stardate' (`dplyr::transmute()`) and remove the instances of the string 'date ' (`stringr::str_replace()`)
* create a season column that manually applies the season number to each row depending on its episode number (`dplyr::mutate(case_when())`)
* remove strings not in the form XXXXX.X (`dplyr::if_else()`)
* remove any NAs (`dplyr::filter()`)

```{r tidy}
stardate_tidy <- stardate_extract %>% 
  tibble::enframe() %>% 
  tidyr::unnest() %>% 
  dplyr::transmute(
    episode = name,
    stardate = stringr::str_replace(
      string = value,
      pattern = "date ",
      replacement = ""
    )
  ) %>% 
  dplyr::mutate(
    season = as.character(
      case_when(
        episode %in% 1:25 ~ "1",
        episode %in% 26:47 ~ "2",
        episode %in% 48:73 ~ "3",
        episode %in% 74:99 ~ "4",
        episode %in% 100:125 ~ "5",
        episode %in% 126:151 ~ "6",
        episode %in% 152:176 ~ "7"
      )
    ),
    stardate = as.numeric(
      dplyr::if_else(
        condition = stardate %in% c("41148..", "40052..", "37650.."),
        true = "NA",
        false = stardate
      )
    )
  ) %>% 
  dplyr::filter(!is.na(stardate))

glimpse(stardate_tidy)
```

# On screen!

Let's visualise the stardates by episode. 

We can make this interactive using plot

We can use the theme

```{r dotplot}
library(ggplot2)
library(plotly)
library(ggsci)
library(ggthemes)

stardate_dotplot <- stardate_tidy %>% 
  ggplot2::ggplot() +
  geom_point(aes(x = episode, y = stardate, color = season)) +
  labs(title = "Stardates are almost (but not quite) chronological") +
  theme_solarized_2(light = FALSE) + 
  scale_color_startrek()

plotly::ggplotly(stardate_dotplot)
```


# Enhance

Extract them.

```{r }
stardate_tidy_decimal <- stardate_tidy %>% 
  mutate(
    stardate_decimal = as.numeric(
      str_sub(
        as.character(stardate),
        7,
        7
      )
    ),
    stardate_decimal = ifelse(
      is.na(stardate_decimal),
      0,
      stardate_decimal
    )
  ) %>% 
  select(season, episode, stardate, stardate_decimal)
```

Datatable of them.

```{r datatable}
library(DT)

stardate_tidy_decimal %>% 
  mutate(season = as.factor(season)) %>% 
  DT::datatable(
    filter = "top",
    extensions = 'Buttons',
      options = list(
        autoWidth = TRUE,  # column width consistent when making selections
        dom = "Blfrtip",
        buttons = 
          list("copy", list(
            extend = "collection",
            buttons = c("csv", "excel", "pdf"),
            text = "Download"
          ) 
          ),
        # customize the length menu
        lengthMenu = list(
          c(10, 25, 50, -1), # declare values
          c(10, 25, 50, "All") # declare titles
        ), # end of lengthMenu customization
        pageLength = 10
      )
    )
```

Do a barplot.

```{r barplot}
stardate_tidy_decimal %>% 
  ggplot2::ggplot() +
  geom_bar(aes(as.character(stardate_decimal)), fill = "#CC0C00FF") +
  labs(
   title = "Decimals one to three are most frequent and zero the least frequent",
    x = "stardate decimal value"
  ) +
  theme_dark() +
  theme_solarized_2(light = FALSE)
```

# Belay that

```{r barplot_facet}
stardate_tidy_decimal %>% 
  ggplot2::ggplot() +
  geom_bar(
    aes(as.character(stardate_decimal)),
    fill= c(
      rep("#CC0C00FF", 10),
      rep("#5C88DAFF", 9),
      rep("#84BD00FF", 10),
      rep("#FFCD00FF", 9),
      rep("#7C878EFF", 10),
      rep("#00B5E2FF", 8),
      rep("#00AF66FF", 8)
    )
  ) +
  labs(
    title = "There's a similar(ish) pattern of decimal stardate frequency across seasons",
    x = "stardate decimal value"
  ) +
  facet_wrap(~ season) +
  theme_solarized_2(light = FALSE) + 
  scale_color_startrek()
```

# Speculate!

# Links

* Memory Alpha: http://memory-alpha.wikia.com/wiki/Stardate?title=Stardate
* Starchive: http://starchive.cs.umanitoba.ca/?stardates/
* Universal stardate converter: http://rinsanity.weebly.com/stardate-converter.html
* If you actually care about stardates, you can look here: http://trekguide.com/Stardates.htm
* Mentalfloss simplified guide: http://mentalfloss.com/article/68741/how-do-star-trek-stardates-work
* List of episodes: https://en.wikipedia.org/wiki/List_of_Star_Trek:_The_Next_Generation_episodes

# R information

```{r}
sessionInfo()
```

[^1]: The star date for today's date (7 March 2018) as calculated using the [trekguide.com method](http://trekguide.com/Stardates.htm)